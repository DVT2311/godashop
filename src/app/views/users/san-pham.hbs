<main id="maincontent" class="page-main">
    <div class="container">
        <div class="row">
            <div class="col-xs-9">
                <ol class="breadcrumb">
                    <li><a href="/" target="_self">Trang chủ</a></li>
                    <li><span>/</span></li>
                    <li class="active"><span>Tất cả sản phẩm</span></li>
                </ol>
            </div>
            <div class="col-xs-3 hidden-lg hidden-md">
                <a class="hidden-lg pull-right btn-aside-mobile" href="javascript:void(0)">Bộ lọc <i
                        class="fa fa-angle-double-right"></i></a>
            </div>
            <div class="clearfix"></div>
            <aside class="col-md-3">
                <div class="inner-aside">
                    <div class="category">
                        <h5>Danh mục sản phẩm</h5>
                        <ul>
                            <li class="active">
                                <a href="/san-pham" title="Tất cả sản phẩm" target="_self">Tất cả sản
                                    phẩm
                                </a>
                            </li>
                            {{#each category}}
                            <li class="">
                                <a href="/san-pham?category_id={{this.id}}" title="{{this.name}}"
                                    target="_self">{{this.name}}</a>
                            </li>
                            {{/each}}
                        </ul>
                    </div>
                    <div class="price-range">
                        <h5>Khoảng giá</h5>
                        <ul>
                            <li>
                                <label for="filter-default">
                                    <input type="radio" id="filter-default" name="filter-price" value="-">
                                    <i class="fa"></i>
                                    Mặc định
                                </label>
                            </li>
                            <li>
                                <label for="filter-less-100">
                                    <input type="radio" id="filter-less-100" name="filter-price" value="0-100000">
                                    <i class="fa"></i>
                                    Giá dưới 100.000đ
                                </label>
                            </li>
                            <li>
                                <label for="filter-100-200">
                                    <input type="radio" id="filter-100-200" name="filter-price" value="100000-200000">
                                    <i class="fa"></i>
                                    100.000đ - 200.000đ
                                </label>
                            </li>
                            <li>
                                <label for="filter-200-300">
                                    <input type="radio" id="filter-200-300" name="filter-price" value="200000-300000">
                                    <i class="fa"></i>
                                    200.000đ - 300.000đ
                                </label>
                            </li>
                            <li>
                                <label for="filter-300-500">
                                    <input type="radio" id="filter-300-500" name="filter-price" value="300000-500000">
                                    <i class="fa"></i>
                                    300.000đ - 500.000đ
                                </label>
                            </li>
                            <li>
                                <label for="filter-500-1000">
                                    <input type="radio" id="filter-500-1000" name="filter-price" value="500000-1000000">
                                    <i class="fa"></i>
                                    500.000đ - 1.000.000đ
                                </label>
                            </li>
                            <li>
                                <label for="filter-greater-1000">
                                    <input type="radio" id="filter-greater-1000" name="filter-price"
                                        value="1000000-greater">
                                    <i class="fa"></i>
                                    Giá trên 1.000.000đ
                                </label>
                            </li>
                        </ul>
                    </div>
                </div>
            </aside>
            <div class="col-md-9 products">
                <div class="row equal" id="product-list">
                    <div class="col-xs-6">
                        <h4 class="home-title">Tất cả sản phẩm</h4>
                    </div>
                    <div class="col-xs-6 sort-by">
                        <div class="pull-right">
                            <label class="left hidden-xs" for="sort-select">Sắp xếp: </label>
                            <select id="sort-select">
                                <option value="" selected>Mặc định</option>
                                <option value="price-asc">Giá tăng dần</option>
                                <option value="price-desc">Giá giảm dần</option>
                                <option value="alpha-asc">Từ A-Z</option>
                                <option value="alpha-desc">Từ Z-A</option>
                                <option value="created-asc">Cũ đến mới</option>
                                <option value="created-desc">Mới đến cũ</option>
                            </select>
                        </div>
                    </div>
                    <div class="clearfix"></div>
                    {{#each products}}
                    <div class="col-xs-6 col-sm-4">
                        <div class="product-container">
                            <div class="image">
                                <img class="img-responsive" src="users/images/{{this.featured_image}}" alt="">
                            </div>
                            <div class="product-meta">
                                <h5 class="name">
                                    <a class="product-name" href="chi-tiet-san-pham.html"
                                        title="{{this.name}}">{{this.name}}</a>
                                </h5>
                                <div class="product-item-price">
                                    <span class="product-item-regular" {{#if (eq this.price this.sale_price)}}
                                        hidden{{/if}}>{{this.price}}</span>
                                    <span class="product-item-discount">{{this.sale_price}}</span>
                                </div>
                            </div>
                            <div class="button-product-action clearfix">
                                <div class="cart icon">
                                    <a class="btn btn-outline-inverse buy" product-id="2" href="javascript:void(0)"
                                        title="Thêm vào giỏ">
                                        Thêm vào giỏ <i class="fa fa-shopping-cart"></i>
                                    </a>
                                </div>
                                <div class="quickview icon">
                                    <a class="btn btn-outline-inverse" href="chi-tiet-san-pham.html" title="Xem nhanh">
                                        Xem chi tiết <i class="fa fa-eye"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {{/each}}
                </div>
                <!-- Paging -->
                <ul class="pagination pull-right">
                    <li class="active"><a href="javascript:void(0)" onclick="goToPage(1)">1</a></li>
                    <li class=""><a href="javascript:void(0)" onclick="goToPage(2)">2</a></li>
                    <li class=""><a href="javascript:void(0)" onclick="goToPage(3)">3</a></li>
                    <li><a href="javascript:void(0)" onclick="goToPage(2)">&raquo;</a></li>
                </ul>
                <!-- End paging -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let filters = {
                category_id: "",
                min_price: "",
                max_price: "",
                sort_by: "",
                page: 1,
                limit: 6// Số sản phẩm mỗi trang
            };

            // ✅ 1. Lọc theo danh mục
            const menuItems = document.querySelectorAll(".category ul li");
            menuItems.forEach(item => {
                item.addEventListener("click", function (event) {
                    event.preventDefault(); // Ngăn chặn load lại trang

                    // Bỏ class active trên tất cả các li
                    menuItems.forEach(li => li.classList.remove("active"));

                    // Thêm class active vào phần tử được bấm
                    this.classList.add("active");

                    // Lấy category_id từ href của thẻ <a>
                    const link = this.querySelector("a");
                    const urlParams = new URL(link.href).searchParams;
                    filters.category_id = urlParams.get("category_id") ?? null;
                    filters.page = 1;
                    fetchProducts();

                });
            });
            // ✅ 2. Lọc theo giá
            const menuPriceRange = document.querySelectorAll("input[name='filter-price']");
            menuPriceRange.forEach((radio) => {
                radio.addEventListener("change", function () {
                    // Xóa class "checked" khỏi tất cả radio button
                    menuPriceRange.forEach(item => item.parentElement.classList.remove("checked"));

                    // Thêm class "checked" vào label của radio được chọn
                    this.parentElement.classList.add("checked");

                    // Lấy giá trị của radio button được chọn
                    let RangePrice = this.value;
                    const [minPrice, maxPrice] = RangePrice.split("-");
                    filters.min_price = minPrice;
                    filters.max_price = maxPrice;
                    filters.page = 1;
                    fetchProducts();
                });
            });


            // ✅ 3. Sắp xếp
            document.getElementById("sort-select").addEventListener("change", (event) => {
                filters.sort_by = event.target.value || "";
                filters.page = 1;
                fetchProducts();
            });

            // ✅ 4. Hàm lấy sản phẩm bằng fetch
            async function fetchProducts() {
                let query = new URLSearchParams(filters).toString();
                let url = `/san-pham/filter-product?${query}`;

                try {
                    let response = await fetch(url);
                    let data = await response.json();
                    updateProductList(data.products);
                    updatePagination(data.totalPages, data.currentPage);
                } catch (error) {
                    console.error("Lỗi tải sản phẩm:", error);
                }
            }


            function updateProductList(products) {
                const productContainer = document.getElementById("product-list");
                // Xóa chỉ các sản phẩm cũ, giữ lại tiêu đề và bộ lọc
                productContainer.querySelectorAll(".col-xs-6.col-sm-4").forEach(product => product.remove());

                // Thêm sản phẩm mới
                products.forEach(product => {
                    const productItem = document.createElement("div");
                    productItem.classList.add("col-xs-6", "col-sm-4");
                    productItem.innerHTML = `
            <div class="product-container">
                <div class="image">
                    <img class="img-responsive" src="users/images/${product.featured_image}" alt="${product.name}">
                </div>
                <div class="product-meta">
                    <h5 class="name">
                        <a class="product-name" href="chi-tiet-san-pham.html" title="${product.name}">${product.name}</a>
                    </h5>
                    <div class="product-item-price">
                    
                    ${product.price !== product.sale_price ? `<span class="product-item-regular">${product.price}</span>` : ''}
                        
                        <span class="product-item-discount">${product.sale_price}</span>
                    </div>
                </div>
                <div class="button-product-action clearfix">
                    <div class="cart icon">
                        <a class="btn btn-outline-inverse buy" product-id="${product.id}" href="javascript:void(0)"
                            title="Thêm vào giỏ">
                            Thêm vào giỏ <i class="fa fa-shopping-cart"></i>
                        </a>
                    </div>
                    <div class="quickview icon">
                        <a class="btn btn-outline-inverse" href="chi-tiet-san-pham.html" title="Xem nhanh">
                            Xem chi tiết <i class="fa fa-eye"></i>
                        </a>
                    </div>
                </div>
            </div>
        `;
                    productContainer.appendChild(productItem);
                });
            }

            // ✅ 6. Cập nhật phân trang
            function updatePagination(totalPages, currentPage) {
                console.log(totalPages, currentPage)
                const paginationContainer = document.querySelector(".pagination");
                console.log(paginationContainer)
                paginationContainer.innerHTML = ""; // Xóa trang cũ

                if (totalPages <= 1) return; // Nếu chỉ có 1 trang thì không hiển thị phân trang

                // Nút "Trang trước"
                if (currentPage > 1) {
                    paginationContainer.innerHTML += `<li><a href="javascript:void(0)" onclick="goToPage(${currentPage - 1})">&laquo;</a></li>`;
                }

                for (let i = 1; i <= totalPages; i++) {
                    paginationContainer.innerHTML += `
                <li class="${i === currentPage ? 'active' : ''}">
                    <a href="javascript:void(0)" onclick="goToPage(${i})">${i}</a>
                </li>
            `;
                }

                // Nút "Trang sau"
                if (currentPage < totalPages) {
                    paginationContainer.innerHTML += `<li><a href="javascript:void(0)" onclick="goToPage(${currentPage + 1})">&raquo;</a></li>`;
                }
            }

            // ✅ 7. Chuyển trang
            window.goToPage = function (page) {
                filters.page = page;
                fetchProducts();
            };

        });



    </script>
</main>